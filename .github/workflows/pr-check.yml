name: PR Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Check formatting
      run: npm run lint

    - name: Type check
      run: npm run compile

    - name: Run tests
      run: npm test
      continue-on-error: true

    - name: Build check
      run: npm run build:prod

    - name: Package check
      run: npm run package

    - name: Check package size
      run: |
        VSIX_SIZE=$(stat -f%z *.vsix 2>/dev/null || stat -c%s *.vsix)
        VSIX_SIZE_KB=$((VSIX_SIZE / 1024))
        echo "ðŸ“¦ Package size: ${VSIX_SIZE_KB} KB"

        if [ $VSIX_SIZE_KB -gt 10240 ]; then
          echo "âš ï¸ Warning: Package size exceeds 10 MB"
          exit 1
        fi

    - name: Comment PR
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          const stats = fs.statSync(fs.readdirSync('.').find(f => f.endsWith('.vsix')));
          const sizeKB = Math.round(stats.size / 1024);

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `âœ… Build successful!\n\nðŸ“¦ Package size: **${sizeKB} KB**`
          });
