name: PR Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Check formatting
      run: npm run lint
      continue-on-error: true

    - name: Type check
      run: npm run compile

    - name: Build check
      run: npm run build:prod

    - name: Package check
      run: npm run package

    - name: Check package size
      id: package_size
      run: |
        if ls *.vsix 1> /dev/null 2>&1; then
          VSIX_FILE=$(ls *.vsix | head -1)
          VSIX_SIZE=$(stat -c%s "$VSIX_FILE" 2>/dev/null || stat -f%z "$VSIX_FILE")
          VSIX_SIZE_KB=$((VSIX_SIZE / 1024))
          echo "size_kb=$VSIX_SIZE_KB" >> $GITHUB_OUTPUT
          echo "Package: $VSIX_FILE"
          echo "Size: ${VSIX_SIZE_KB} KB"
          
          if [ $VSIX_SIZE_KB -gt 10240 ]; then
            echo "Warning: Package size exceeds 10 MB"
            exit 1
          fi
        else
          echo "No VSIX package found"
          exit 1
        fi

    - name: Comment PR
      uses: actions/github-script@v7
      if: always()
      with:
        script: |
          const sizeKB = '${{ steps.package_size.outputs.size_kb }}' || 'Unknown';
          const status = '${{ job.status }}' === 'success' ? '‚úÖ' : '‚ùå';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `${status} Build completed!\n\nüì¶ Package size: **${sizeKB} KB**`
          });
